-- ===== Services =====
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- ===== States =====
local selectedPlayer = nil
local guiEnabled = true
local playerButtons = {}
local isMinimized = false

-- ===== GUI =====
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "TeleportGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = player:WaitForChild("PlayerGui")

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 300, 0, 400)
MainFrame.Position = UDim2.new(0, 30, 0, 200)
MainFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
MainFrame.Active = true
MainFrame.Parent = ScreenGui
Instance.new("UICorner", MainFrame)

-- ===== Drag =====
do
	local dragging, dragStart, startPos
	MainFrame.InputBegan:Connect(function(inp)
		if inp.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			dragStart = inp.Position
			startPos = MainFrame.Position
		end
	end)
	MainFrame.InputEnded:Connect(function(inp)
		if inp.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = false
		end
	end)
	UserInputService.InputChanged:Connect(function(inp)
		if dragging and inp.UserInputType == Enum.UserInputType.MouseMovement then
			local delta = inp.Position - dragStart
			MainFrame.Position = UDim2.new(
				startPos.X.Scale, startPos.X.Offset + delta.X,
				startPos.Y.Scale, startPos.Y.Offset + delta.Y
			)
		end
	end)
end

-- ===== Title =====
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1,-120,0,40)
Title.Position = UDim2.new(0,10,0,10)
Title.BackgroundTransparency = 1
Title.Text = "Xu-順步"
Title.TextColor3 = Color3.new(1,1,1)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 20
Title.Parent = MainFrame

-- ===== Buttons =====
local CloseButton = Instance.new("TextButton")
CloseButton.Size = UDim2.new(0,40,0,30)
CloseButton.Position = UDim2.new(1,-50,0,15)
CloseButton.Text = "X"
CloseButton.Font = Enum.Font.SourceSansBold
CloseButton.TextSize = 18
CloseButton.TextColor3 = Color3.new(1,1,1)
CloseButton.BackgroundColor3 = Color3.fromRGB(170,60,60)
CloseButton.Parent = MainFrame
Instance.new("UICorner", CloseButton)

local MinimizeButton = Instance.new("TextButton")
MinimizeButton.Size = UDim2.new(0,40,0,30)
MinimizeButton.Position = UDim2.new(1,-100,0,15)
MinimizeButton.Text = "-"
MinimizeButton.Font = Enum.Font.SourceSansBold
MinimizeButton.TextSize = 18
MinimizeButton.TextColor3 = Color3.new(1,1,1)
MinimizeButton.BackgroundColor3 = Color3.fromRGB(100,100,100)
MinimizeButton.Parent = MainFrame
Instance.new("UICorner", MinimizeButton)

-- ===== Player List =====
local ScrollingFrame = Instance.new("ScrollingFrame")
ScrollingFrame.Size = UDim2.new(1,-20,1,-130)
ScrollingFrame.Position = UDim2.new(0,10,0,60)
ScrollingFrame.ScrollBarImageTransparency = 0.3
ScrollingFrame.Parent = MainFrame

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Padding = UDim.new(0,6)
UIListLayout.Parent = ScrollingFrame

-- ===== Teleport Button =====
local TeleportButton = Instance.new("TextButton")
TeleportButton.Size = UDim2.new(1,-20,0,40)
TeleportButton.Position = UDim2.new(0,10,1,-50)
TeleportButton.Text = "TP (G)"
TeleportButton.Font = Enum.Font.SourceSansBold
TeleportButton.TextSize = 18
TeleportButton.TextColor3 = Color3.new(1,1,1)
TeleportButton.BackgroundColor3 = Color3.fromRGB(70,140,220)
TeleportButton.Parent = MainFrame
Instance.new("UICorner", TeleportButton)

-- ===== Refresh Player List =====
local function refreshPlayers()
	for _, b in pairs(playerButtons) do b:Destroy() end
	playerButtons = {}

	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= player then
			local btn = Instance.new("TextButton")
			btn.Size = UDim2.new(1,-10,0,35)
			btn.Text = plr.Name
			btn.Font = Enum.Font.SourceSans
			btn.TextSize = 16
			btn.TextColor3 = Color3.new(1,1,1)
			btn.BackgroundColor3 = (plr == selectedPlayer)
				and Color3.fromRGB(80,180,80)
				or Color3.fromRGB(120,120,120)

			btn.Parent = ScrollingFrame
			Instance.new("UICorner", btn)

			btn.MouseButton1Click:Connect(function()
				selectedPlayer = plr
				for _, other in pairs(playerButtons) do
					other.BackgroundColor3 = Color3.fromRGB(120,120,120)
				end
				btn.BackgroundColor3 = Color3.fromRGB(80,180,80)
			end)

			playerButtons[plr] = btn
		end
	end

	task.wait()
	ScrollingFrame.CanvasSize =
		UDim2.new(0,0,0,UIListLayout.AbsoluteContentSize.Y + 10)
end

-- ===== Teleport Logic（水平順移、貼近玩家）=====
local function teleportToPlayer()
	if not guiEnabled or not selectedPlayer then return end

	local myChar = player.Character
	local targetChar = selectedPlayer.Character
	if not (myChar and targetChar) then return end

	local myHRP = myChar:FindFirstChild("HumanoidRootPart")
	local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
	if not (myHRP and targetHRP) then return end

	local distance = 8

	-- 只取 Camera 水平方向
	local flatDir = Vector3.new(
		Camera.CFrame.LookVector.X,
		0,
		Camera.CFrame.LookVector.Z
	)
	if flatDir.Magnitude < 0.01 then return end
	flatDir = flatDir.Unit

	-- 高度貼近玩家，避免出現自己比玩家高而飄到頭上
	local playerHRP_Y = targetHRP.Position.Y

	-- 可選加一個微調，讓自己站在玩家旁邊的地面高度
	local finalPos = Vector3.new(
		targetHRP.Position.X,
		playerHRP_Y,       -- 貼近玩家水平面
		targetHRP.Position.Z
	) - flatDir * distance

	-- 朝向：水平看前方
	myHRP.CFrame = CFrame.new(
		finalPos,
		finalPos + flatDir
	)
end

-- ===== Connections =====
TeleportButton.MouseButton1Click:Connect(teleportToPlayer)

UserInputService.InputBegan:Connect(function(input, gp)
	if gp or not guiEnabled then return end
	if input.KeyCode == Enum.KeyCode.G then
		teleportToPlayer()
	end
end)

CloseButton.MouseButton1Click:Connect(function()
	guiEnabled = false
	ScreenGui.Enabled = false
end)

MinimizeButton.MouseButton1Click:Connect(function()
	if isMinimized then
		ScrollingFrame.Visible = true
		TeleportButton.Visible = true
		MainFrame.Size = UDim2.new(0,300,0,400)
		isMinimized = false
	else
		ScrollingFrame.Visible = false
		TeleportButton.Visible = false
		MainFrame.Size = UDim2.new(0,200,0,50)
		isMinimized = true
	end
end)

Players.PlayerAdded:Connect(refreshPlayers)
Players.PlayerRemoving:Connect(refreshPlayers)

refreshPlayers()
