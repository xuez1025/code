local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

local selectedPlayer = nil
local guiEnabled = true
local playerButtons = {}
local isMinimized = false

-- ── 核心變數 ───────────────────────────────────────
local _G = _G or {}
_G.YFlash_Enabled = false
_G.WaitTime     = 0.45
_G.VoidY        = -200000
_G.FlashDuration = 0.55

local skillKeywords = {
    "z", "x", "c", "v", "f", "expl", "blast", "beam", "laser", "slash",
    "punch", "impact", "boom", "shock", "earth", "fire", "ice", "hit",
    "rhapsody", "fortissimo", "symphonic", "harmony", "tempo", "quake",
    "magma", "phoenix"
}

local excludeKeywords = {
    "jump", "jumps", "jumping", "jumpstart", "jumpvoice", "leap",
    "land", "lands", "landing", "landed", "landground", "touchdown",
    "fall", "falling", "fell", "落地", "drop", "落地聲",
    "step", "steps", "foot", "footstep", "footsteps", "footprint", "footprints",
    "run", "running", "walk", "walking", "sprint",
    "dash", "dashing", "roll", "rolling", "dodge",
    "swim", "swimming", "splash", "water", "wave", "bubble",
    "ground", "grass", "sand", "wood", "floor", "hitground", "impactground",
    "idle", "breath", "breathe", "eat", "drink", "emote", "chat", "talk",
    "die", "death", "hurt", "pain", "damage"
}

-- ── GUI 建立 ───────────────────────────────────────────────────
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "Teleport_And_YFlash_GUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = player:WaitForChild("PlayerGui")

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 300, 0, 520)
MainFrame.Position = UDim2.new(0, 30, 0, 180)
MainFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
MainFrame.Active = true
MainFrame.Parent = ScreenGui
Instance.new("UICorner", MainFrame)

-- 拖曳功能
do
    local dragging, dragStart, startPos
    MainFrame.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = inp.Position
            startPos = MainFrame.Position
        end
    end)
    MainFrame.InputEnded:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    UserInputService.InputChanged:Connect(function(inp)
        if dragging and inp.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = inp.Position - dragStart
            MainFrame.Position = UDim2.new(
                startPos.X.Scale, startPos.X.Offset + delta.X,
                startPos.Y.Scale, startPos.Y.Offset + delta.Y
            )
        end
    end)
end

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1,-120,0,40)
Title.Position = UDim2.new(0,10,0,10)
Title.BackgroundTransparency = 1
Title.Text = "Xu-秒殺"
Title.TextColor3 = Color3.new(1,1,1)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 20
Title.Parent = MainFrame

local CloseButton = Instance.new("TextButton")
CloseButton.Size = UDim2.new(0,40,0,30)
CloseButton.Position = UDim2.new(1,-50,0,15)
CloseButton.Text = "X"
CloseButton.Font = Enum.Font.SourceSansBold
CloseButton.TextSize = 18
CloseButton.TextColor3 = Color3.new(1,1,1)
CloseButton.BackgroundColor3 = Color3.fromRGB(170,60,60)
CloseButton.Parent = MainFrame
Instance.new("UICorner", CloseButton)

local MinimizeButton = Instance.new("TextButton")
MinimizeButton.Size = UDim2.new(0,40,0,30)
MinimizeButton.Position = UDim2.new(1,-100,0,15)
MinimizeButton.Text = "-"
MinimizeButton.Font = Enum.Font.SourceSansBold
MinimizeButton.TextSize = 18
MinimizeButton.TextColor3 = Color3.new(1,1,1)
MinimizeButton.BackgroundColor3 = Color3.fromRGB(100,100,100)
MinimizeButton.Parent = MainFrame
Instance.new("UICorner", MinimizeButton)

local ScrollingFrame = Instance.new("ScrollingFrame")
ScrollingFrame.Size = UDim2.new(1,-20,0,240)
ScrollingFrame.Position = UDim2.new(0,10,0,60)
ScrollingFrame.ScrollBarImageTransparency = 0.3
ScrollingFrame.Parent = MainFrame

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Padding = UDim.new(0,6)
UIListLayout.Parent = ScrollingFrame

local TeleportButton = Instance.new("TextButton")
TeleportButton.Size = UDim2.new(1,-20,0,40)
TeleportButton.Position = UDim2.new(0,10,0,310)
TeleportButton.Text = "TP player(G)"
TeleportButton.Font = Enum.Font.SourceSansBold
TeleportButton.TextSize = 18
TeleportButton.TextColor3 = Color3.new(1,1,1)
TeleportButton.BackgroundColor3 = Color3.fromRGB(70,140,220)
TeleportButton.Parent = MainFrame
Instance.new("UICorner", TeleportButton)

local SectionLabel = Instance.new("TextLabel")
SectionLabel.Size = UDim2.new(1,-20,0,30)
SectionLabel.Position = UDim2.new(0,10,0,360)
SectionLabel.BackgroundTransparency = 1
SectionLabel.Text = "秒殺(Alt)"
SectionLabel.TextColor3 = Color3.fromRGB(180,180,180)
SectionLabel.Font = Enum.Font.SourceSansSemibold
SectionLabel.TextSize = 16
SectionLabel.Parent = MainFrame

local YFlashToggle = Instance.new("TextButton")
YFlashToggle.Size = UDim2.new(1,-20,0,40)
YFlashToggle.Position = UDim2.new(0,10,0,395)
YFlashToggle.Text = "關閉"
YFlashToggle.Font = Enum.Font.SourceSansBold
YFlashToggle.TextSize = 18
YFlashToggle.TextColor3 = Color3.new(1,1,1)
YFlashToggle.BackgroundColor3 = Color3.fromRGB(200,50,50)
YFlashToggle.Parent = MainFrame
Instance.new("UICorner", YFlashToggle)

-- ── 邏輯處理 ─────────────────────────────────────────

local function updateYFlashUI()
    YFlashToggle.Text = _G.YFlash_Enabled and "開啟" or "關閉"
    YFlashToggle.BackgroundColor3 = _G.YFlash_Enabled 
        and Color3.fromRGB(50,200,50) 
        or Color3.fromRGB(200,50,50)
end

local function toggleYFlash()
    _G.YFlash_Enabled = not _G.YFlash_Enabled
    updateYFlashUI()
end

local function refreshPlayers()
    for _, b in pairs(playerButtons) do b:Destroy() end
    playerButtons = {}
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= player then
            local btn = Instance.new("TextButton")
            btn.Size = UDim2.new(1,-10,0,35)
            btn.Text = plr.Name
            btn.Font = Enum.Font.SourceSans
            btn.TextSize = 16
            btn.TextColor3 = Color3.new(1,1,1)
            btn.BackgroundColor3 = (plr == selectedPlayer) and Color3.fromRGB(80,180,80) or Color3.fromRGB(120,120,120)
            btn.Parent = ScrollingFrame
            Instance.new("UICorner", btn)
            btn.MouseButton1Click:Connect(function()
                selectedPlayer = plr
                for _, other in pairs(playerButtons) do other.BackgroundColor3 = Color3.fromRGB(120,120,120) end
                btn.BackgroundColor3 = Color3.fromRGB(80,180,80)
            end)
            playerButtons[plr] = btn
        end
    end
    ScrollingFrame.CanvasSize = UDim2.new(0,0,0,UIListLayout.AbsoluteContentSize.Y + 10)
end

local function teleportToPlayer()
    if not guiEnabled or not selectedPlayer then return end
    local myChar = player.Character
    local targetChar = selectedPlayer.Character
    if not (myChar and targetChar) then return end
    
    local myHRP = myChar:FindFirstChild("HumanoidRootPart")
    local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
    if not (myHRP and targetHRP) then return end
    
    local distance = 8
    local flatDir = Vector3.new(Camera.CFrame.LookVector.X, 0, Camera.CFrame.LookVector.Z)
    if flatDir.Magnitude < 0.01 then return end
    flatDir = flatDir.Unit
    
    local finalPos = Vector3.new(targetHRP.Position.X, targetHRP.Position.Y, targetHRP.Position.Z) - flatDir * distance
    myHRP.CFrame = CFrame.new(finalPos, finalPos + flatDir)
end

-- ── Y軸閃避監控 ──────────────────────────────────────────
local RootConnection
local function setupYFlashListener()
    if RootConnection then RootConnection:Disconnect() end
    local Character = player.Character
    if not Character then return end
    local Root = Character:WaitForChild("HumanoidRootPart", 5)
    if not Root then return end
    
    RootConnection = Root.ChildAdded:Connect(function(child)
        if not _G.YFlash_Enabled or not child:IsA("Sound") then return end
        
        local name = child.Name:lower()
        for _, kw in ipairs(excludeKeywords) do if name:find(kw) then return end end
        if child.TimeLength < 0.7 or child.Volume < 0.6 then return end
        
        for _, kw in ipairs(skillKeywords) do
            if name:find(kw) then
                task.spawn(function()
                    task.wait(_G.WaitTime)
                    if not _G.YFlash_Enabled or not Root or not Root.Parent then return end
                    
                    local originalCFrame = Root.CFrame
                    local downPos = Vector3.new(originalCFrame.Position.X, _G.VoidY, originalCFrame.Position.Z)
                    local conn
                    conn = RunService.Heartbeat:Connect(function()
                        if not _G.YFlash_Enabled or not Root or not Root.Parent then
                            if conn then conn:Disconnect() end
                            return
                        end
                        Root.CFrame = CFrame.new(downPos) * originalCFrame.Rotation
                    end)
                    
                    task.wait(_G.FlashDuration)
                    if conn then conn:Disconnect() end
                    if Root and Root.Parent then Root.CFrame = originalCFrame end
                end)
                break
            end
        end
    end)
end

-- ── 事件綁定 ─────────────────────────────────────────────
TeleportButton.MouseButton1Click:Connect(teleportToPlayer)
YFlashToggle.MouseButton1Click:Connect(toggleYFlash)

UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end -- 如果在聊天則不觸發
    if input.KeyCode == Enum.KeyCode.G then
        teleportToPlayer()
    elseif input.KeyCode == Enum.KeyCode.LeftAlt or input.KeyCode == Enum.KeyCode.RightAlt then
        toggleYFlash()
    end
end)

CloseButton.MouseButton1Click:Connect(function()
    guiEnabled = false
    ScreenGui.Enabled = false
end)

MinimizeButton.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    local visible = not isMinimized
    ScrollingFrame.Visible = visible
    TeleportButton.Visible = visible
    SectionLabel.Visible   = visible
    YFlashToggle.Visible   = visible
    MainFrame.Size = isMinimized and UDim2.new(0,200,0,50) or UDim2.new(0,300,0,520)
end)

Players.PlayerAdded:Connect(refreshPlayers)
Players.PlayerRemoving:Connect(refreshPlayers)
player.CharacterAdded:Connect(function()
    task.wait(0.6)
    setupYFlashListener()
end)

-- 初始化
refreshPlayers()
setupYFlashListener()
print("腳本已加載：[G] 瞬移 | [Alt] 切換 Y軸閃避")
