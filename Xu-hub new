-- ===== 基本服務 =====
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")

-- ===== FastAttack 核心 =====
local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegisterAttack = Net:WaitForChild("RE/RegisterAttack")
local RegisterHit = Net:WaitForChild("RE/RegisterHit")
local EnemiesFolder = workspace:WaitForChild("Enemies")
local CharactersFolder = workspace:WaitForChild("Characters")

_G.FastAttack = true
local Settings = {
    AutoClick = true,
    Distance = 50,
    AttackInterval = 0.01,
    MaxTargets = 20
}

local function IsAlive(char)
    local hum = char:FindFirstChild("Humanoid")
    return hum and hum.Health > 0
end

-- ===== Xu-hub UI =====
local screenGui = Instance.new("ScreenGui")
screenGui.Parent = PlayerGui
screenGui.Name = "XuHubGui"

-- 小長方形開關
local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(0,120,0,50)
toggleBtn.Position = UDim2.new(0.5,-60,0,0)
toggleBtn.Text = "Xu-hub"
toggleBtn.BackgroundColor3 = Color3.fromRGB(50,50,50)
toggleBtn.TextColor3 = Color3.fromRGB(255,255,255)
toggleBtn.BorderSizePixel = 0
toggleBtn.TextScaled = true
toggleBtn.Parent = screenGui
local toggleCorner = Instance.new("UICorner")
toggleCorner.CornerRadius = UDim.new(0,10)
toggleCorner.Parent = toggleBtn

-- 主框架
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0,900,0,650)
mainFrame.Position = UDim2.new(0.5,-450,0.5,-325)
mainFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
mainFrame.BackgroundTransparency = 0.3
mainFrame.BorderSizePixel = 0
mainFrame.Visible = false
mainFrame.Parent = screenGui
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0,10)
UICorner.Parent = mainFrame

-- 標題列
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1,0,0,50)
titleBar.BackgroundColor3 = Color3.fromRGB(20,20,20)
titleBar.BackgroundTransparency = 0.3
titleBar.Parent = mainFrame

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1,-20,1,0)
titleLabel.Position = UDim2.new(0,10,0,0)
titleLabel.Text = "Xu-hub"
titleLabel.TextColor3 = Color3.fromRGB(255,255,255)
titleLabel.BackgroundTransparency = 1
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Font = Enum.Font.SourceSansBold
titleLabel.TextSize = 32
titleLabel.Parent = titleBar

-- 關閉按鈕
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0,30,0,30)
closeBtn.Position = UDim2.new(1,-40,0,10)
closeBtn.Text = "X"
closeBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
closeBtn.BackgroundTransparency = 0.2
closeBtn.TextColor3 = Color3.fromRGB(255,255,255)
closeBtn.Parent = titleBar
closeBtn.MouseButton1Click:Connect(function()
    mainFrame:Destroy()
    toggleBtn:Destroy()
end)

-- 縮小化按鈕 (-)
local minimizeBtn = Instance.new("TextButton")
minimizeBtn.Size = UDim2.new(0,30,0,30)
minimizeBtn.Position = UDim2.new(1,-80,0,10)
minimizeBtn.Text = "-"
minimizeBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
minimizeBtn.BackgroundTransparency = 0.2
minimizeBtn.TextColor3 = Color3.fromRGB(255,255,255)
minimizeBtn.Parent = titleBar

local isMinimized = false
local originalSize = mainFrame.Size
local originalPosition = mainFrame.Position

-- 左側側欄
local sideBar = Instance.new("ScrollingFrame")
sideBar.Size = UDim2.new(0,180,1,-50)
sideBar.Position = UDim2.new(0,0,0,50)
sideBar.BackgroundColor3 = Color3.fromRGB(50,50,50)
sideBar.BackgroundTransparency = 0.4
sideBar.BorderSizePixel = 0
sideBar.ScrollBarThickness = 6
sideBar.Parent = mainFrame
local sideUICorner = Instance.new("UICorner")
sideUICorner.CornerRadius = UDim.new(0,10)
sideUICorner.Parent = sideBar

-- 右側內容區
local contentFrame = Instance.new("ScrollingFrame")
contentFrame.Size = UDim2.new(1,-180,1,-50)
contentFrame.Position = UDim2.new(0,180,0,50)
contentFrame.BackgroundColor3 = Color3.fromRGB(40,40,40)
contentFrame.BackgroundTransparency = 0.8
contentFrame.BorderSizePixel = 0
contentFrame.ScrollBarThickness = 6
contentFrame.Parent = mainFrame
local contentCorner = Instance.new("UICorner")
contentCorner.CornerRadius = UDim.new(0,10)
contentCorner.Parent = contentFrame

-- 縮小功能
minimizeBtn.MouseButton1Click:Connect(function()
    if not isMinimized then
        mainFrame.Size = UDim2.new(0, originalSize.X.Offset, 0, titleBar.Size.Y.Offset)
        isMinimized = true
        contentFrame.Visible = false
        sideBar.Visible = false
    else
        mainFrame.Size = originalSize
        mainFrame.Position = originalPosition
        isMinimized = false
        contentFrame.Visible = true
        sideBar.Visible = true
    end
end)

-- ===== 側欄按鈕 =====
local buttonNames = {
    "通用", "設定", "Server", "Status", "PVP", 
    "Farm", "想不到", "我太帥了", "天生可能就很帥了", "好像是"
}

local buttons = {}
for i=1,10 do
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1,-20,0,50)
    btn.Position = UDim2.new(0,10,0,10 + (i-1)*60)
    btn.Text = buttonNames[i]
    btn.BackgroundColor3 = Color3.fromRGB(70,70,70)
    btn.TextColor3 = Color3.fromRGB(255,255,255)
    btn.BorderSizePixel = 0
    btn.TextScaled = true
    btn.Font = Enum.Font.SourceSansBold
    btn.Parent = sideBar

    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0,10)
    btnCorner.Parent = btn

    local indicator = Instance.new("Frame")
    indicator.Size = UDim2.new(0,4,1,0)
    indicator.Position = UDim2.new(0,0,0,0)
    indicator.BackgroundColor3 = Color3.fromRGB(0,120,255)
    indicator.Visible = false
    indicator.Parent = btn

    buttons[i] = {Button = btn, Indicator = indicator}
end

-- ===== 右側內容區功能函數 =====
local function contentFunction(index)
    if index == 1 then
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1,0,0,50)
        label.Position = UDim2.new(0,0,0,0)
        label.Text = "通用"
        label.TextColor3 = Color3.fromRGB(255,255,255)
        label.BackgroundTransparency = 1
        label.Font = Enum.Font.SourceSansBold
        label.TextSize =40
        label.Parent = contentFrame

    elseif index == 2 then
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1,0,0,50)
        label.Position = UDim2.new(0,0,0,0)
        label.Text = "設定"
        label.TextColor3 = Color3.fromRGB(255,255,255)
        label.BackgroundTransparency = 1
        label.Font = Enum.Font.SourceSansBold
        label.TextSize = 40
        label.Parent = contentFrame
        
    elseif index == 3 then
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1,0,0,50)
        label.Position = UDim2.new(0,0,0,0)
        label.Text = "server"
        label.TextColor3 = Color3.fromRGB(255,255,255)
        label.BackgroundTransparency = 1
        label.Font = Enum.Font.SourceSansBold
        label.TextSize = 40
        label.Parent = contentFrame

    elseif index == 4 then
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1,0,0,50)
        label.Position = UDim2.new(0,0,0,0)
        label.Text = "狀態"
        label.TextColor3 = Color3.fromRGB(255,255,255)
        label.BackgroundTransparency = 1
        label.Font = Enum.Font.SourceSansBold
        label.TextSize = 40
        label.Parent = contentFrame

    elseif index == 5 then
-- ===== ESP 左右滑動開關 =====
local ESP_ENABLED = false
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")

-- 判斷顏色
local function getESPColor(player)
    if LocalPlayer.Team and player.Team then
        if LocalPlayer.Team == player.Team then
            return Color3.fromRGB(0,255,0)
        else
            return Color3.fromRGB(255,0,0)
        end
    end
    return Color3.fromRGB(255,255,255)
end

-- 建立 / 移除 ESP
local function createESP(player)
    if not player.Character or player.Character:FindFirstChild("ESP_Highlight") then return end
    local h = Instance.new("Highlight")
    h.Name = "ESP_Highlight"
    h.FillColor = getESPColor(player)
    h.OutlineColor = Color3.fromRGB(255,255,255)
    h.FillTransparency = 0.2
    h.OutlineTransparency = 0
    h.Adornee = player.Character
    h.Parent = player.Character

    local head = player.Character:FindFirstChild("Head")
    if head then
        local bill = Instance.new("BillboardGui")
        bill.Name = "ESP_Billboard"
        bill.Size = UDim2.fromOffset(180,50)
        bill.StudsOffset = Vector3.new(0,3,0)
        bill.AlwaysOnTop = true
        bill.Parent = head

        local text = Instance.new("TextLabel")
        text.Name = "Info"
        text.Size = UDim2.fromOffset(180,50)
        text.Position = UDim2.fromOffset(0,0)
        text.BackgroundTransparency = 1
        text.TextColor3 = getESPColor(player)
        text.TextStrokeTransparency = 0
        text.TextTransparency = 0.2
        text.Font = Enum.Font.SourceSansBold
        text.TextSize = 24
        text.Text = player.Name
        text.Parent = bill
    end
end

local function removeESP(player)
    if player.Character then
        local h = player.Character:FindFirstChild("ESP_Highlight")
        if h then h:Destroy() end
        local head = player.Character:FindFirstChild("Head")
        if head then
            local bill = head:FindFirstChild("ESP_Billboard")
            if bill then bill:Destroy() end
        end
    end
end

local function refreshESP()
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then
            if ESP_ENABLED then
                createESP(p)
            else
                removeESP(p)
            end
        end
    end
end

-- ===== PVP 分頁內 UI =====
local container = Instance.new("Frame")
container.Size = UDim2.new(1, -20, 0, 60)
container.Position = UDim2.fromOffset(10, 10)
container.BackgroundColor3 = Color3.fromRGB(70,70,70) -- 整行底色
container.Parent = contentFrame
local containerCorner = Instance.new("UICorner")
containerCorner.CornerRadius = UDim.new(0,10)
containerCorner.Parent = container

-- 左側文字
local label = Instance.new("TextLabel")
label.Text = "ESP"
label.Font = Enum.Font.SourceSansBold
label.TextSize = 40
label.TextColor3 = Color3.fromRGB(255,255,255)
label.BackgroundTransparency = 1
label.Size = UDim2.new(0,150,1,0)
label.Position = UDim2.new(0,10,0,0)
label.TextXAlignment = Enum.TextXAlignment.Left
label.TextYAlignment = Enum.TextYAlignment.Center
label.Parent = container

-- 右側滑動開關容器
local switchContainer = Instance.new("Frame")
switchContainer.Size = UDim2.new(0, 60, 0, 30)
switchContainer.Position = UDim2.new(1, -70, 0.5, 0)
switchContainer.AnchorPoint = Vector2.new(1,0.5)
switchContainer.BackgroundColor3 = Color3.fromRGB(100,100,100)
switchContainer.Parent = container
local switchCorner = Instance.new("UICorner")
switchCorner.CornerRadius = UDim.new(0,15)
switchCorner.Parent = switchContainer

-- 滑塊
local knob = Instance.new("Frame")
knob.Size = UDim2.new(0,28,1,0)
knob.Position = UDim2.new(0,1,0,0)
knob.BackgroundColor3 = Color3.fromRGB(255,255,255)
knob.Parent = switchContainer
local knobCorner = Instance.new("UICorner")
knobCorner.CornerRadius = UDim.new(0,14)
knobCorner.Parent = knob

-- 滑動邏輯
local dragging = false
local dragStart = nil
local knobStart = nil

local function updateSwitch(state)
    ESP_ENABLED = state
    refreshESP()
    if ESP_ENABLED then
        knob.Position = UDim2.new(1, -knob.Size.X.Offset - 1, 0, 0)
        switchContainer.BackgroundColor3 = Color3.fromRGB(0,170,0)
    else
        knob.Position = UDim2.new(0,1,0,0)
        switchContainer.BackgroundColor3 = Color3.fromRGB(100,100,100)
    end
end

-- 點擊切換
switchContainer.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        updateSwitch(not ESP_ENABLED)
    elseif input.UserInputType == Enum.UserInputType.Touch then
        updateSwitch(not ESP_ENABLED)
    end
end)

-- 拖動滑塊
knob.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        knobStart = knob.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
                -- 判斷最終位置
                if knob.Position.X.Scale > 0.5 then
                    updateSwitch(true)
                else
                    updateSwitch(false)
                end
            end
        end)
    end
end)

knob.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
    if dragging and input == dragInput then
        local delta = input.Position.X - dragStart.X
        local containerWidth = switchContainer.AbsoluteSize.X - knob.AbsoluteSize.X - 2
        local newX = math.clamp(knobStart.X.Offset + delta,0,containerWidth)
        knob.Position = UDim2.new(0,newX,0,0)
    end
end)

-- ===== 玩家事件 =====
local function setupPlayerESP(p)
    p.CharacterAdded:Connect(function()
        task.wait(0.2)
        if ESP_ENABLED then createESP(p) end
    end)
    if ESP_ENABLED and p.Character then
        createESP(p)
    end
end

for _, p in ipairs(Players:GetPlayers()) do
    if p ~= LocalPlayer then
        setupPlayerESP(p)
    end
end

Players.PlayerAdded:Connect(setupPlayerESP)
Players.PlayerRemoving:Connect(removeESP)

-- ===== RenderStepped 更新 =====
RunService.RenderStepped:Connect(function()
    if ESP_ENABLED and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local myPos = LocalPlayer.Character.HumanoidRootPart.Position
        for _, p in ipairs(Players:GetPlayers()) do
            if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("Head") then
                local bill = p.Character.Head:FindFirstChild("ESP_Billboard")
                local hrp = p.Character:FindFirstChild("HumanoidRootPart")
                if bill and hrp then
                    local info = bill:FindFirstChild("Info")
                    if info then
                        info.Text = p.Name.." ["..math.floor((myPos-hrp.Position).Magnitude).."m]"
                        info.TextColor3 = getESPColor(p)
                    end
                    local highlight = p.Character:FindFirstChild("ESP_Highlight")
                    if highlight then
                        highlight.FillColor = getESPColor(p)
                    end
                end
            end
        end
    end
end)

    elseif index == 6 then
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1,0,0,50)
        label.Position = UDim2.new(0,0,0,0)
        label.Text = "Farm"
        label.TextColor3 = Color3.fromRGB(255,255,255)
        label.BackgroundTransparency = 1
        label.Font = Enum.Font.SourceSansBold
        label.TextSize = 40
        label.Parent = contentFrame

    elseif index == 7 then
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1,0,0,50)
        label.Position = UDim2.new(0,0,0,0)
        label.Text = "待開發"
        label.TextColor3 = Color3.fromRGB(255,255,255)
        label.BackgroundTransparency = 1
        label.Font = Enum.Font.SourceSansBold
        label.TextSize = 80
        label.Parent = contentFrame

    elseif index == 8 then
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1,0,0,50)
        label.Position = UDim2.new(0,0,0,0)
        label.Text = "待開發"
        label.TextColor3 = Color3.fromRGB(255,255,255)
        label.BackgroundTransparency = 1
        label.Font = Enum.Font.SourceSansBold
        label.TextSize = 80
        label.Parent = contentFrame

    elseif index == 9 then
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1,0,0,50)
        label.Position = UDim2.new(0,0,0,0)
        label.Text = "待開發"
        label.TextColor3 = Color3.fromRGB(255,255,255)
        label.BackgroundTransparency = 1
        label.Font = Enum.Font.SourceSansBold
        label.TextSize = 80
        label.Parent = contentFrame

    elseif index == 10 then
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1,0,0,50)
        label.Position = UDim2.new(0,0,0,0)
        label.Text = "待開發"
        label.TextColor3 = Color3.fromRGB(255,255,255)
        label.BackgroundTransparency = 1
        label.Font = Enum.Font.SourceSansBold
        label.TextSize = 80
        label.Parent = contentFrame
    end
end

-- ===== 點擊側欄按鈕顯示內容（內容區完全空白） =====
local function showContent(index)
    -- 側欄指示條
    for i, b in ipairs(buttons) do
        b.Indicator.Visible = (i == index)
    end

    -- 清空右側內容區
    contentFrame:ClearAllChildren()

    -- 呼叫對應功能結構
    contentFunction(index)
end

for i, b in ipairs(buttons) do
    b.Button.MouseButton1Click:Connect(function()
        showContent(i)
    end)
end

-- 顯示 / 隱藏主框架
toggleBtn.MouseButton1Click:Connect(function()
    mainFrame.Visible = not mainFrame.Visible
end)

-- ===== 可拖動功能 =====
local dragging = false
local dragInput
local dragStart
local startPos

local function update(input)
    local delta = input.Position - dragStart
    mainFrame.Position = UDim2.new(
        startPos.X.Scale,
        startPos.X.Offset + delta.X,
        startPos.Y.Scale,
        startPos.Y.Offset + delta.Y
    )
end

titleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position

        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

titleBar.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)
