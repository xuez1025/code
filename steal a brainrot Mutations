-- ================== Services ==================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local VirtualInput = game:GetService("VirtualInputManager")
local ProximityPromptService = game:GetService("ProximityPromptService")

local player = Players.LocalPlayer

-- ================== 狀態 ==================
local antiKnockbackEnabled = true
local autoBuyEnabled = false
local heartbeatConnection
local autoBuyLoopRunning = false
local canBuy = false

local HOLD_DURATION = 0.26 -- 按住 E 時長（秒）

-- ================== 防擊退 ==================
local function enableAntiKnockback(character)
    local root = character:WaitForChild("HumanoidRootPart")

    if heartbeatConnection then
        heartbeatConnection:Disconnect()
    end

    heartbeatConnection = RunService.Heartbeat:Connect(function()
        if antiKnockbackEnabled and root.Parent then
            root.AssemblyLinearVelocity = Vector3.zero
            root.AssemblyAngularVelocity = Vector3.zero
        end
    end)
end

local function disableAntiKnockback()
    if heartbeatConnection then
        heartbeatConnection:Disconnect()
        heartbeatConnection = nil
    end
end

-- ================== Auto Buy 核心 ==================
local function holdE()
    VirtualInput:SendKeyEvent(true, "E", false, game)
    task.wait(HOLD_DURATION)
    VirtualInput:SendKeyEvent(false, "E", false, game)
end

local function autoBuyLoop()
    if autoBuyLoopRunning then return end
    autoBuyLoopRunning = true

    while autoBuyEnabled do
        if canBuy then
            holdE() -- 按住 E
            -- 立即再次檢查，不等待
        else
            task.wait(0.1) -- 無法買時稍微等待避免卡死
        end
    end

    autoBuyLoopRunning = false
end

-- ================== GUI ==================
local gui = Instance.new("ScreenGui")
gui.Name = "AntiSystemGui"
gui.ResetOnSpawn = false
gui.Enabled = true
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.fromOffset(260, 200)
frame.Position = UDim2.fromScale(0.5, 0.7) - UDim2.fromOffset(130, 100)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.Parent = gui

-- ===== 右上角叉叉 =====
local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.fromOffset(30, 30)
closeButton.Position = UDim2.fromScale(1, 0) - UDim2.fromOffset(35, -5)
closeButton.Text = "x"
closeButton.TextScaled = true
closeButton.BackgroundColor3 = Color3.fromRGB(140, 40, 40)
closeButton.TextColor3 = Color3.new(1, 1, 1)
closeButton.Parent = frame

-- ===== Anti Attack 按鈕 =====
local antiButton = Instance.new("TextButton")
antiButton.Size = UDim2.fromOffset(240, 45)
antiButton.Position = UDim2.fromOffset(10, 50)
antiButton.TextScaled = true
antiButton.Parent = frame

local function updateAntiButton()
    if antiKnockbackEnabled then
        antiButton.Text = "Anti Attack : ON (Q)"
        antiButton.BackgroundColor3 = Color3.fromRGB(40, 120, 40)
    else
        antiButton.Text = "Anti Attack : OFF (Q)"
        antiButton.BackgroundColor3 = Color3.fromRGB(120, 40, 40)
    end
end

local function toggleAntiKnockback()
    antiKnockbackEnabled = not antiKnockbackEnabled

    if antiKnockbackEnabled and player.Character then
        enableAntiKnockback(player.Character)
    else
        disableAntiKnockback()
    end

    updateAntiButton()
end

antiButton.MouseButton1Click:Connect(toggleAntiKnockback)
updateAntiButton()

-- ===== Auto Buy 按鈕 =====
local autoButton = Instance.new("TextButton")
autoButton.Size = UDim2.fromOffset(240, 45)
autoButton.Position = UDim2.fromOffset(10, 110)
autoButton.TextScaled = true
autoButton.Parent = frame

local function updateAutoButton()
    if not autoBuyEnabled then
        autoButton.Text = "Auto Buy : OFF (R)"
        autoButton.BackgroundColor3 = Color3.fromRGB(120, 40, 40)
    else
        if canBuy then
            autoButton.Text = "Auto Buy : ON (Buying...) (R)"
            autoButton.BackgroundColor3 = Color3.fromRGB(40, 120, 40)
        else
            autoButton.Text = "Auto Buy : ON (Waiting E...) (R)"
            autoButton.BackgroundColor3 = Color3.fromRGB(120, 120, 40)
        end
    end
end

local function toggleAutoBuy()
    autoBuyEnabled = not autoBuyEnabled

    if autoBuyEnabled then
        autoBuyLoop()
    end

    updateAutoButton()
end

autoButton.MouseButton1Click:Connect(toggleAutoBuy)
updateAutoButton()

-- ================== 偵測 E 狀態 ==================
ProximityPromptService.PromptShown:Connect(function(prompt, inputType)
    if inputType == Enum.ProximityPromptInputType.Keyboard then
        canBuy = true
        updateAutoButton()
    end
end)

ProximityPromptService.PromptHidden:Connect(function(prompt, inputType)
    if inputType == Enum.ProximityPromptInputType.Keyboard then
        canBuy = false
        updateAutoButton()
    end
end)

-- ===== 關閉按鈕 =====
local function resetAll()
    antiKnockbackEnabled = false
    autoBuyEnabled = false
    canBuy = false

    disableAntiKnockback()
    gui.Enabled = false
    updateAntiButton()
    updateAutoButton()
end

closeButton.MouseButton1Click:Connect(resetAll)

-- ===== 快捷鍵 =====
UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if not gui.Enabled then return end

    if input.KeyCode == Enum.KeyCode.Q then
        toggleAntiKnockback()
    elseif input.KeyCode == Enum.KeyCode.R then
        toggleAutoBuy()
    end
end)

-- ===== 角色重生處理 =====
player.CharacterAdded:Connect(function(character)
    if antiKnockbackEnabled then
        enableAntiKnockback(character)
    end
end)

if player.Character and antiKnockbackEnabled then
    enableAntiKnockback(player.Character)
end
